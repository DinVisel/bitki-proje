@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@using Bitki.Blazor.Auth
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<AuthorizeView>
    <Authorized>
        <div class="user-info-display">
            <span class="username">@context.User.Identity?.Name</span>
            <span class="role-badge @GetRoleBadgeClass(context.User)">@GetUserRole(context.User)</span>
            <button class="btn btn-outline-light btn-sm logout-btn" @onclick="Logout">Logout</button>
        </div>
    </Authorized>
    <NotAuthorized>
        <a href="login" class="btn btn-outline-light btn-sm">Login</a>
    </NotAuthorized>
</AuthorizeView>

@code {
    private async Task Logout()
    {
        if (AuthStateProvider is CustomAuthenticationStateProvider customAuthStateProvider)
        {
            await customAuthStateProvider.UpdateAuthenticationState(null);
            NavigationManager.NavigateTo("/", true);
        }
        else
        {
            // Fallback navigation or logging if the provider is not the expected custom type
            NavigationManager.NavigateTo("/", true);
        }
    }

    private string GetUserRole(ClaimsPrincipal user)
    {
        if (user == null) return "Unknown";
        var roleClaim = user.FindFirst(ClaimTypes.Role) ?? user.FindFirst("role");
        return roleClaim?.Value ?? "Unknown";
    }

    private string GetRoleBadgeClass(ClaimsPrincipal user)
    {
        if (user == null) return "role-unknown";
        var role = GetUserRole(user);
        return role.ToLowerInvariant() switch
        {
            "admin" => "role-admin",
            "user" => "role-viewer",
            "viewer" => "role-viewer",
            _ => "role-unknown"
        };
    }
}