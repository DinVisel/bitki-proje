@page "/bilesikler/{Id:int}"
@rendermode InteractiveServer
@using Bitki.Blazor.Models
@using Bitki.Blazor.Services
@using Bitki.Blazor.Components.Common
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject AuthenticatedHttpClient AuthHttp
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>@(bilesik?.Name ?? "Bile≈üik Detay")</PageTitle>

<div class="page-container">
    @if (isLoading)
    {
        <div class="text-center mt-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Y√ºkleniyor...</span>
            </div>
        </div>
    }
    else if (bilesik != null)
    {
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h1 class="display-6 fw-bold text-primary mb-1">@bilesik.Name</h1>
                @if (!string.IsNullOrEmpty(bilesik.LatinName))
                {
                    <h4 class="text-muted fst-italic">@bilesik.LatinName</h4>
                }
                @if (!string.IsNullOrEmpty(bilesik.EnglishName))
                {
                    <div class="text-muted">@bilesik.EnglishName</div>
                }
            </div>
            <div class="text-end">
                <span class="badge bg-light text-dark border">ID: @bilesik.Id</span>
                <a href="/bilesikler" class="btn btn-outline-secondary btn-sm ms-2">Listeye D√∂n</a>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        @* SECTION 1: Entity Information *@
        <div class="p-4 border rounded shadow-sm bg-white mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="h5 mb-1">1. Bile≈üik Bilgileri</h2>
                    <div class="text-muted small">T√ºm alanlar yalnƒ±zca bile≈üik tablosunu g√ºnceller.</div>
                </div>
                <AuthorizeView Roles="Admin">
                    <Authorized>
                        @if (!isEditMode)
                        {
                            <button class="btn btn-outline-primary btn-sm" @onclick="EnableEditMode">D√ºzenle</button>
                        }
                        else
                        {
                            <div class="btn-group">
                                <button class="btn btn-success btn-sm" @onclick="SaveEntityChanges" disabled="@isSavingEntity">
                                    @if (isSavingEntity)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                    }
                                    Kaydet
                                </button>
                                <button class="btn btn-secondary btn-sm" @onclick="CancelEdit"
                                    disabled="@isSavingEntity">ƒ∞ptal</button>
                            </div>
                        }
                    </Authorized>
                </AuthorizeView>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Ad</label>
                    @if (isEditMode)
                    {
                        <input type="text" class="form-control" @bind="editModel.Name" />
                    }
                    else
                    {
                        <div class="form-control-plaintext">@DisplayValue(bilesik.Name)</div>
                    }
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold">ƒ∞ngilizce Ad</label>
                    @if (isEditMode)
                    {
                        <input type="text" class="form-control" @bind="editModel.EnglishName" />
                    }
                    else
                    {
                        <div class="form-control-plaintext">@DisplayValue(bilesik.EnglishName)</div>
                    }
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Latince Ad</label>
                    @if (isEditMode)
                    {
                        <input type="text" class="form-control" @bind="editModel.LatinName" />
                    }
                    else
                    {
                        <div class="form-control-plaintext">@DisplayValue(bilesik.LatinName)</div>
                    }
                </div>
                <div class="col-12">
                    <label class="form-label fw-semibold">A√ßƒ±klama</label>
                    @if (isEditMode)
                    {
                        <textarea class="form-control" rows="3" @bind="editModel.Description"></textarea>
                    }
                    else
                    {
                        @if (!string.IsNullOrWhiteSpace(bilesik.Description))
                        {
                            <div class="border rounded p-3 bg-light">@bilesik.Description</div>
                        }
                        else
                        {
                            <div class="text-muted">Bilgi bulunmamaktadƒ±r.</div>
                        }
                    }
                </div>
            </div>
        </div>

        @* SECTION 2: Related Entities (READ-ONLY) *@
        <div class="p-4 border rounded shadow-sm bg-white mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="h5 mb-1">2. ƒ∞li≈ükili Bitkiler</h2>
                    <div class="text-muted small">Bu liste ili≈üki tablosundan okunur ve yalnƒ±zca g√∂r√ºnt√ºleme i√ßindir.</div>
                </div>
            </div>

            @if (relationsLoading)
            {
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                </div>
            }
            else if (relations != null && relations.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Bitki Adƒ±</th>
                                <th>Miktar</th>
                                <th>Birim/A√ßƒ±klama</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var rel in relations)
                            {
                                <tr>
                                    <td>
                                        <a href="/bitki/@rel.PlantId" class="text-decoration-none fw-bold">
                                            @rel.PlantName
                                        </a>
                                    </td>
                                    <td>@(rel.Amount?.ToString() ?? "‚Äî")</td>
                                    <td>@(rel.Description ?? "‚Äî")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-light border text-center py-4 text-muted">
                    Bu bile≈üik hen√ºz hi√ßbir bitki ile ili≈ükilendirilmemi≈ü.
                </div>
            }
        </div>

        @* SECTION 3: Relationship Management (ADMIN ONLY) *@
        <AuthorizeView Roles="Admin">
            <Authorized>
                <div class="p-4 border rounded shadow-sm bg-white mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h2 class="h5 mb-1">3. ƒ∞li≈üki Y√∂netimi</h2>
                            <div class="text-muted small">Ekle/Sil i≈ülemleri yalnƒ±zca bitki-bile≈üik ili≈üki tablosunu
                                etkiler.</div>
                        </div>
                        <button class="btn btn-success btn-sm" @onclick="OpenAddModal">
                            <span>‚ûï</span> Bitki ile ƒ∞li≈ükilendir
                        </button>
                    </div>

                    @if (relationsLoading)
                    {
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                        </div>
                    }
                    else if (relations != null && relations.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Bitki Adƒ±</th>
                                        <th>Miktar</th>
                                        <th>Birim/A√ßƒ±klama</th>
                                        <th class="text-end" style="width: 100px;">ƒ∞≈ülemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var rel in relations)
                                    {
                                        <tr>
                                            <td>
                                                <a href="/bitki/@rel.PlantId" class="text-decoration-none fw-bold">
                                                    @rel.PlantName
                                                </a>
                                            </td>
                                            <td>@(rel.Amount?.ToString() ?? "‚Äî")</td>
                                            <td>@(rel.Description ?? "‚Äî")</td>
                                            <td class="text-end">
                                                <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteRelation(rel)">
                                                    üóëÔ∏è
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-light border text-center py-4 text-muted">
                            Bu bile≈üik hen√ºz hi√ßbir bitki ile ili≈ükilendirilmemi≈ü.
                        </div>
                    }
                </div>
            </Authorized>
        </AuthorizeView>
    }
    else
    {
        <div class="alert alert-danger">
            Bile≈üik bulunamadƒ±. <a href="/bilesikler" class="alert-link">Listeye d√∂n</a>
        </div>
    }
</div>

@* Add Relation Modal *@
@if (showAddModal)
{
    <div class="modal-overlay"
        style="display:block; background-color: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bitki ƒ∞li≈ükisi Ekle</h5>
                    <button type="button" class="btn-close" @onclick="CloseAddModal"></button>
                </div>
                <div class="modal-body">

                    @* Step 1: Search Plant *@
                    <div class="mb-4">
                        <label class="form-label fw-bold">1. Bitki Se√ß</label>
                        @if (selectedPlant == null)
                        {
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" @bind="plantSearchQuery" @bind:event="oninput"
                                    @onkeyup="HandleSearchInput" placeholder="Bitki adƒ± ara..." />
                                <button class="btn btn-outline-secondary" type="button" @onclick="SearchPlants">Ara</button>
                            </div>

                            @if (isSearchingPlants)
                            {
                                <div class="text-center py-2"><small class="text-muted">Aranƒ±yor...</small></div>
                            }
                            else if (foundPlants != null && foundPlants.Any())
                            {
                                <div class="list-group border" style="max-height: 200px; overflow-y: auto;">
                                    @foreach (var p in foundPlants)
                                    {
                                        <button type="button" class="list-group-item list-group-item-action"
                                            @onclick="() => SelectPlant(p)">
                                            @p.Name <small class="text-muted ms-2">(@p.LatinName)</small>
                                        </button>
                                    }
                                </div>
                            }
                            else if (foundPlants != null && !foundPlants.Any())
                            {
                                <div class="text-muted small">Sonu√ß bulunamadƒ±.</div>
                            }
                        }
                        else
                        {
                            <div class="alert alert-success d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Se√ßilen Bitki:</strong> @selectedPlant.Name <span
                                        class="text-muted">(@selectedPlant.LatinName)</span>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" @onclick="ClearSelectedPlant">Deƒüi≈ütir</button>
                            </div>
                        }
                    </div>

                    @* Step 2: Details *@
                    <div class="mb-3">
                        <label class="form-label fw-bold">2. Detaylar</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label small">Miktar</label>
                                <input type="number" step="0.01" class="form-control" @bind="newRelation.Amount"
                                    disabled="@(selectedPlant == null)" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Birim / A√ßƒ±klama</label>
                                <input type="text" class="form-control" @bind="newRelation.Description"
                                    placeholder="√ñrn: % veya mg" disabled="@(selectedPlant == null)" />
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddModal">ƒ∞ptal</button>
                    <button type="button" class="btn btn-success" @onclick="SaveRelation"
                        disabled="@(selectedPlant == null || isSaving)">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private BilesiklerViewModel? bilesik;
    private BilesikEditModel editModel = new();
    private List<BitkiBilesikViewModel>? relations;
    private bool isLoading = true;
    private bool relationsLoading = false;
    private bool isEditMode = false;
    private bool isSavingEntity = false;
    private string? errorMessage;

    // Modal State
    private bool showAddModal = false;
    private string plantSearchQuery = "";
    private List<BitkiViewModel>? foundPlants;
    private bool isSearchingPlants = false;
    private BitkiViewModel? selectedPlant;
    private BitkiBilesikViewModel newRelation = new();
    private bool isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            errorMessage = null;
            // Update to use the correct endpoint for fetching by ID
            // Assuming we can fetch by ID or using query. If there is no specific GetById for BilesiklerViewModel, we use query.
            // BilesiklerRepository likely has GetById, exposed as GET api/bilesikler/{id}
            bilesik = await Http.GetFromJsonAsync<BilesiklerViewModel>($"api/bilesikler/{Id}");

            if (bilesik != null)
            {
                MapToEditModel();
                await LoadRelations();
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Bile≈üik bilgileri y√ºklenemedi.";
            Console.WriteLine(ex);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadRelations()
    {
        relationsLoading = true;
        try
        {
            var filter = new FilterRequest
            {
                Filters = new Dictionary<string, string> { { "CompoundId", Id.ToString() } },
                PageSize = 1000 // Fetch all for now
            };

            var response = await Http.PostAsJsonAsync("api/bitkibilesik/query", filter);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<FilterResponse<BitkiBilesikViewModel>>();
                relations = result?.Data.ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
        finally
        {
            relationsLoading = false;
        }
    }

    // Modal Actions
    private void EnableEditMode()
    {
        if (bilesik == null) return;

        MapToEditModel();
        isEditMode = true;
    }

    private void CancelEdit()
    {
        MapToEditModel();
        isEditMode = false;
    }

    private void MapToEditModel()
    {
        if (bilesik == null) return;

        editModel = new BilesikEditModel
        {
            Id = bilesik.Id,
            Name = bilesik.Name,
            EnglishName = bilesik.EnglishName,
            LatinName = bilesik.LatinName,
            Description = bilesik.Description
        };
    }

    private async Task SaveEntityChanges()
    {
        if (bilesik == null) return;

        isSavingEntity = true;
        errorMessage = null;

        try
        {
            var updated = new BilesiklerViewModel
            {
                Id = editModel.Id,
                Name = editModel.Name,
                EnglishName = editModel.EnglishName,
                LatinName = editModel.LatinName,
                Description = editModel.Description
            };

            var response = await AuthHttp.PutAsJsonAsync($"api/bilesikler/{updated.Id}", updated);
            if (response.IsSuccessStatusCode)
            {
                isEditMode = false;
                await LoadData();
            }
            else
            {
                errorMessage = "Bile≈üik g√ºncellenemedi. Yetkinizi veya alanlarƒ± kontrol edin.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Hata: {ex.Message}";
        }
        finally
        {
            isSavingEntity = false;
        }
    }

    private void OpenAddModal()
    {
        selectedPlant = null;
        plantSearchQuery = "";
        foundPlants = null;
        newRelation = new BitkiBilesikViewModel { CompoundId = Id };
        showAddModal = true;
    }

    private void CloseAddModal()
    {
        showAddModal = false;
    }

    private async Task HandleSearchInput(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchPlants();
        }
    }

    private async Task SearchPlants()
    {
        if (string.IsNullOrWhiteSpace(plantSearchQuery) || plantSearchQuery.Length < 2) return;

        isSearchingPlants = true;
        try
        {
            var filter = new FilterRequest
            {
                SearchText = plantSearchQuery,
                PageSize = 20
            };

            var response = await Http.PostAsJsonAsync("api/bitki/query", filter);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<FilterResponse<BitkiViewModel>>();
                foundPlants = result?.Data.ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
        finally
        {
            isSearchingPlants = false;
        }
    }

    private void SelectPlant(BitkiViewModel plant)
    {
        selectedPlant = plant;
        newRelation.PlantId = plant.Id;
        newRelation.PlantName = plant.Name;
    }

    private void ClearSelectedPlant()
    {
        selectedPlant = null;
        foundPlants = null;
    }

    private async Task SaveRelation()
    {
        if (selectedPlant == null) return;

        // Validation: Prevent duplicates
        if (relations != null && relations.Any(r => r.PlantId == selectedPlant.Id))
        {
            await JS.InvokeVoidAsync("alert", "Bu bitki zaten bu bile≈üikle ili≈ükilendirilmi≈ü!");
            return;
        }

        isSaving = true;
        try
        {
            var response = await AuthHttp.PostAsJsonAsync("api/bitkibilesik", newRelation);
            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "ƒ∞li≈üki ba≈üarƒ±yla eklendi!");
                CloseAddModal();
                await LoadRelations();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                await JS.InvokeVoidAsync("alert", "Oturum a√ßmanƒ±z gerekiyor.");
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                await JS.InvokeVoidAsync("alert", "Yetkiniz yok.");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Bir hata olu≈ütu.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Hata: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteRelation(BitkiBilesikViewModel item)
    {
        if (!await JS.InvokeAsync<bool>("confirm", $"{item.PlantName} ile olan ili≈ükiyi silmek istediƒüinize emin misiniz?"))
            return;

        try
        {
            var response = await AuthHttp.DeleteAsync($"api/bitkibilesik/{item.Id}");
            if (response.IsSuccessStatusCode)
            {
                await LoadRelations();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Silinemedi. Yetkinizi kontrol edin.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Hata: {ex.Message}");
        }
    }

    private static string DisplayValue(string? value) => string.IsNullOrWhiteSpace(value) ? "‚Äî" : value!;

    private class BilesikEditModel
    {
        public long Id { get; set; }
        public string? Name { get; set; }
        public string? EnglishName { get; set; }
        public string? LatinName { get; set; }
        public string? Description { get; set; }
    }
}