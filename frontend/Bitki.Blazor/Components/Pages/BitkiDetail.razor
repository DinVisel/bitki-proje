@page "/bitki/{Id:int}"
@rendermode InteractiveServer
@using Bitki.Blazor.Models
@using Bitki.Blazor.Components.Common
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>@(bitki?.DisplayName ?? "Bitki Detay")</PageTitle>

<div class="detail-page @(isEditMode ? "edit-mode" : "")">
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Y√ºkleniyor...</span>
            </div>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">@errorMessage</div>
        <a href="/bitki" class="btn btn-secondary">‚Üê Listeye D√∂n</a>
    }
    else if (bitki != null)
    {
        @* Admin Action Bar *@
        <AuthorizeView Roles="Admin">
            <Authorized>
                @if (isEditMode)
                {
                    <div class="action-bar">
                        <button class="btn btn-success" @onclick="SaveChanges">Kaydet</button>
                        <button class="btn btn-secondary" @onclick="CancelEdit">ƒ∞ptal</button>
                    </div>
                }
            </Authorized>
        </AuthorizeView>

        @* Breadcrumb Navigation *@
        <Breadcrumb Items="@breadcrumbItems" />

        @* Header Section *@
        <div class="detail-header">
            <div class="header-content">
                <h1>@bitki.DisplayName</h1>
                @if (!string.IsNullOrEmpty(bitki.LatinName) && bitki.LatinName != bitki.TurkishName)
                {
                    <div class="latin-name">@bitki.LatinName</div>
                }
                <div class="metadata-row">
                    <span class="metadata-badge id-badge">ID: @bitki.Id</span>
                    @if (!string.IsNullOrEmpty(bitki.FamilyName))
                    {
                        <span class="metadata-badge">@bitki.FamilyName</span>
                    }
                    @if (!string.IsNullOrEmpty(bitki.GenusName))
                    {
                        <span class="metadata-badge">@bitki.GenusName</span>
                    }
                    @if (!string.IsNullOrEmpty(bitki.Status))
                    {
                        <span class="metadata-badge">@bitki.Status</span>
                    }
                    <AuthorizeView Roles="Admin">
                        <Authorized>
                            @if (!isEditMode)
                            {
                                <button class="btn btn-sm btn-outline-primary" @onclick="EnableEditMode">D√ºzenle</button>
                            }
                        </Authorized>
                    </AuthorizeView>
                </div>
            </div>
        </div>

        @* Flags Row *@
        <div class="flags-row">
            @if (bitki.IsMedicinal)
            {
                <span class="flag medicinal">üíä Tƒ±bbi</span>
            }
            @if (bitki.IsFood)
            {
                <span class="flag food">üçÉ Gƒ±da</span>
            }
            @if (bitki.IsCultural)
            {
                <span class="flag cultural">üå± K√ºlt√ºr</span>
            }
            @if (bitki.IsPoisonous)
            {
                <span class="flag poisonous">‚ò†Ô∏è Zehirli</span>
            }
            @if (bitki.IsTurkishFlora)
            {
                <span class="flag flora">üáπüá∑ TF</span>
            }
            @if (bitki.IsExtinct)
            {
                <span class="flag extinct">‚ùå Yok Olmu≈ü</span>
            }
            @if (bitki.IsIslandSpecies)
            {
                <span class="flag island">üèùÔ∏è Ada</span>
            }
        </div>

        @* Tab Navigation *@
        <div class="tab-navigation">
            <button class="tab-btn @(activeTab == "general" ? "active" : "")" @onclick="@(() => SetTab("general"))">
                Genel Bilgiler
            </button>
            <button class="tab-btn @(activeTab == "taxonomy" ? "active" : "")" @onclick="@(() => SetTab("taxonomy"))">
                Taksonomi
            </button>
            <button class="tab-btn @(activeTab == "ecology" ? "active" : "")" @onclick="@(() => SetTab("ecology"))">
                Ekoloji & Daƒüƒ±lƒ±m
            </button>
            <button class="tab-btn @(activeTab == "compounds" ? "active" : "")" @onclick="@(() => SetTab("compounds"))">
                Bile≈üikler (@bitki.Compounds.Count)
            </button>
            <button class="tab-btn @(activeTab == "images" ? "active" : "")" @onclick="@(() => SetTab("images"))">
                G√∂rseller (@bitki.Images.Count)
            </button>
            <button class="tab-btn @(activeTab == "literature" ? "active" : "")" @onclick="@(() => SetTab("literature"))">
                Literat√ºr (@bitki.Literature.Count)
            </button>
        </div>

        @* Tab Content *@
        <div class="tab-content">
            @if (activeTab == "general")
            {
                <CollapsibleSection Title="Temel Bilgiler">
                    <div class="field-grid">
                        <span class="field-label">T√ºrk√ße Ad</span>
                        <span class="field-value">@DisplayValue(bitki.TurkishName)</span>

                        <span class="field-label">Latince Ad</span>
                        <span class="field-value">@DisplayValue(bitki.LatinName)</span>

                        <span class="field-label">Yerel Adlar</span>
                        <span class="field-value">@DisplayValue(bitki.CommonNames)</span>

                        <span class="field-label">Durum</span>
                        <span class="field-value">@DisplayValue(bitki.Status)</span>
                    </div>
                </CollapsibleSection>

                <CollapsibleSection Title="A√ßƒ±klama">
                    @if (!string.IsNullOrEmpty(bitki.Description))
                    {
                        @if (bitki.Description.Length > 300)
                        {
                            <div class="long-text-container">
                                <div class="description-box long-text-content @(descriptionExpanded ? "expanded" : "")">
                                    @bitki.Description
                                </div>
                                @if (!descriptionExpanded)
                                {
                                    <div class="long-text-gradient"></div>
                                }
                                <button class="show-more-btn" @onclick="@(() => descriptionExpanded = !descriptionExpanded)">
                                    @(descriptionExpanded ? "Daha az g√∂ster" : "Daha fazla g√∂ster")
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="description-box">@bitki.Description</div>
                        }
                    }
                    else
                    {
                        <span class="empty-value">Bilgi bulunmamaktadƒ±r</span>
                    }
                </CollapsibleSection>

                @if (!string.IsNullOrEmpty(bitki.Notes) || !string.IsNullOrEmpty(bitki.AdditionalInfo))
                {
                    <CollapsibleSection Title="Ek Notlar" DefaultExpanded="false">
                        @if (!string.IsNullOrEmpty(bitki.Notes))
                        {
                            <h4>Notlar</h4>
                            <div class="description-box">@bitki.Notes</div>
                        }
                        @if (!string.IsNullOrEmpty(bitki.AdditionalInfo))
                        {
                            <h4>Ek Bilgi</h4>
                            <div class="description-box">@bitki.AdditionalInfo</div>
                        }
                    </CollapsibleSection>
                }

                <CollapsibleSection Title="√ñzellikler" DefaultExpanded="false">
                    <div class="flags-detail-grid">
                        <div class="flag-item @(bitki.IsMedicinal ? "active" : "")">
                            <span class="flag-indicator"></span>Tƒ±bbi Kullanƒ±m
                        </div>
                        <div class="flag-item @(bitki.IsFood ? "active" : "")">
                            <span class="flag-indicator"></span>Gƒ±da Olarak
                        </div>
                        <div class="flag-item @(bitki.IsCultural ? "active" : "")">
                            <span class="flag-indicator"></span>K√ºlt√ºr Bitkisi
                        </div>
                        <div class="flag-item @(bitki.IsPoisonous ? "active" : "")">
                            <span class="flag-indicator"></span>Zehirli
                        </div>
                        <div class="flag-item @(bitki.IsTurkishFlora ? "active" : "")">
                            <span class="flag-indicator"></span>T√ºrkiye Florasƒ±
                        </div>
                        <div class="flag-item @(bitki.IsIslandSpecies ? "active" : "")">
                            <span class="flag-indicator"></span>Ada T√ºr√º
                        </div>
                        <div class="flag-item @(bitki.ExistenceDoubtful ? "active" : "")">
                            <span class="flag-indicator"></span>Varlƒ±k ≈û√ºpheli
                        </div>
                        <div class="flag-item @(bitki.NeedsRevision ? "active" : "")">
                            <span class="flag-indicator"></span>Revizyon Gerekli
                        </div>
                        <div class="flag-item @(bitki.IsExtinct ? "active" : "")">
                            <span class="flag-indicator"></span>Yok Olmu≈ü
                        </div>
                        <div class="flag-item @(bitki.IncompleteIdentification ? "active" : "")">
                            <span class="flag-indicator"></span>Eksik Te≈ühis
                        </div>
                        <div class="flag-item @(bitki.ControlOk ? "active" : "")">
                            <span class="flag-indicator"></span>Kontrol OK
                        </div>
                        <div class="flag-item @(bitki.PublicationOk ? "active" : "")">
                            <span class="flag-indicator"></span>Yayƒ±n OK
                        </div>
                    </div>
                </CollapsibleSection>
            }
            else if (activeTab == "taxonomy")
            {
                <CollapsibleSection Title="Sƒ±nƒ±flandƒ±rma">
                    <div class="field-grid">
                        <span class="field-label">Familya</span>
                        <span class="field-value">
                            @DisplayValue(bitki.FamilyName)
                            @if (!string.IsNullOrEmpty(bitki.FamilyTurkishName))
                            {
                                <span class="text-muted"> (@bitki.FamilyTurkishName)</span>
                            }
                        </span>

                        <span class="field-label">Genus</span>
                        <span class="field-value">@DisplayValue(bitki.GenusName)</span>

                        <span class="field-label">Takson Adƒ±</span>
                        <span class="field-value">@DisplayValue(bitki.TaxonName)</span>

                        <span class="field-label">Takson D√ºzeyi</span>
                        <span class="field-value">@DisplayValue(bitki.TaxonLevel)</span>

                        <span class="field-label">Takson Cinsi</span>
                        <span class="field-value">@DisplayValue(bitki.TaxonKind)</span>

                        <span class="field-label">Takson Ot√∂r√º</span>
                        <span class="field-value">@DisplayValue(bitki.TaxonOtor)</span>
                    </div>
                </CollapsibleSection>

                <CollapsibleSection Title="Ot√∂r Bilgileri">
                    <div class="field-grid">
                        <span class="field-label">Ot√∂r</span>
                        <span class="field-value">@DisplayValue(bitki.Otor)</span>

                        <span class="field-label">Basionim Ot√∂r</span>
                        <span class="field-value">@DisplayValue(bitki.BasionymOtor)</span>

                        <span class="field-label">Yƒ±l</span>
                        <span class="field-value">@DisplayValue(bitki.Year)</span>

                        <span class="field-label">Sayfa</span>
                        <span class="field-value">@DisplayValue(bitki.Pages)</span>
                    </div>
                </CollapsibleSection>

                @if (!string.IsNullOrEmpty(bitki.Synonym))
                {
                    <CollapsibleSection Title="Sinonim Bilgileri" DefaultExpanded="false">
                        <div class="field-grid">
                            <span class="field-label">Sinonim</span>
                            <span class="field-value">@bitki.Synonym</span>

                            <span class="field-label">Sinonim Ot√∂r</span>
                            <span class="field-value">@DisplayValue(bitki.SynonymOtor)</span>
                        </div>
                    </CollapsibleSection>
                }
            }
            else if (activeTab == "ecology")
            {
                <CollapsibleSection Title="Endemizm & Fitocoƒürafya">
                    <div class="field-grid">
                        <span class="field-label">Endemizm</span>
                        <span class="field-value">@DisplayValue(bitki.Endemism)</span>

                        <span class="field-label">Endemizm A√ßƒ±klama</span>
                        <span class="field-value">@DisplayValue(bitki.EndemismDescription)</span>

                        <span class="field-label">Fitocoƒürafya</span>
                        <span class="field-value">@DisplayValue(bitki.Phytogeography)</span>

                        <span class="field-label">√ái√ßeklenme Zamanƒ±</span>
                        <span class="field-value">@DisplayValue(bitki.FloweringTime)</span>

                        <span class="field-label">Rakƒ±m/Y√ºkseklik</span>
                        <span class="field-value">@DisplayValue(bitki.Altitude)</span>
                    </div>
                </CollapsibleSection>

                <CollapsibleSection Title="Ya≈üam Alanƒ±">
                    @if (!string.IsNullOrEmpty(bitki.Habitat))
                    {
                        <div class="description-box">@bitki.Habitat</div>
                    }
                    else
                    {
                        <span class="empty-value">Bilgi bulunmamaktadƒ±r</span>
                    }
                </CollapsibleSection>

                <CollapsibleSection Title="Daƒüƒ±lƒ±m">
                    @if (!string.IsNullOrEmpty(bitki.Distribution))
                    {
                        <div class="description-box">@bitki.Distribution</div>
                    }
                    else
                    {
                        <span class="empty-value">Bilgi bulunmamaktadƒ±r</span>
                    }
                </CollapsibleSection>

                @if (!string.IsNullOrEmpty(bitki.References))
                {
                    <CollapsibleSection Title="Kaynaklar" DefaultExpanded="false">
                        <div class="description-box">@bitki.References</div>
                    </CollapsibleSection>
                }
            }
            else if (activeTab == "compounds")
            {
                <CollapsibleSection Title="Bile≈üikler">
                    @if (compoundsLoading)
                    {
                        <div class="tab-loading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span>Bile≈üikler y√ºkleniyor...</span>
                        </div>
                    }
                    else if (bitki.Compounds.Any())
                    {
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th>Bile≈üik Adƒ±</th>
                                    <th>ƒ∞ngilizce</th>
                                    <th>Latince</th>
                                    <th>Miktar</th>
                                    <th>A√ßƒ±klama</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var compound in bitki.Compounds)
                                {
                                    <tr>
                                        <td>@DisplayValue(compound.CompoundName)</td>
                                        <td>@DisplayValue(compound.CompoundEnglishName)</td>
                                        <td>@DisplayValue(compound.CompoundLatinName)</td>
                                        <td>@(compound.Amount?.ToString("F2") ?? "‚Äî")</td>
                                        <td>@DisplayValue(compound.Description)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="empty-state-small">Bu bitki i√ßin kayƒ±tlƒ± bile≈üik bulunmuyor.</div>
                    }
                </CollapsibleSection>
            }
            else if (activeTab == "images")
            {
                <CollapsibleSection Title="G√∂rseller">
                    @if (imagesLoading)
                    {
                        <div class="tab-loading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span>G√∂rseller y√ºkleniyor...</span>
                        </div>
                    }
                    else if (bitki.Images.Any())
                    {
                        <div class="image-grid">
                            @foreach (var image in bitki.Images)
                            {
                                <div class="image-card">
                                    <div class="image-placeholder-box">üì∑</div>
                                    <div class="image-info">
                                        <div class="image-path">@image.ImageLocation</div>
                                        @if (!string.IsNullOrEmpty(image.Description))
                                        {
                                            <div class="image-desc">@image.Description</div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-state-small">Bu bitki i√ßin kayƒ±tlƒ± g√∂rsel bulunmuyor.</div>
                    }
                </CollapsibleSection>
            }
            else if (activeTab == "literature")
            {
                <CollapsibleSection Title="Literat√ºr">
                    @if (literatureLoading)
                    {
                        <div class="tab-loading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span>Literat√ºr y√ºkleniyor...</span>
                        </div>
                    }
                    else if (bitki.Literature.Any())
                    {
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th>Yazar</th>
                                    <th>Ara≈ütƒ±rma Adƒ±</th>
                                    <th>Kaynak</th>
                                    <th>Yƒ±l</th>
                                    <th>T√ºr</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var lit in bitki.Literature)
                                {
                                    <tr>
                                        <td>@DisplayValue(lit.AuthorName)</td>
                                        <td>@DisplayValue(lit.ResearchName)</td>
                                        <td>@DisplayValue(lit.SourceName)</td>
                                        <td>@(lit.Year?.ToString() ?? "‚Äî")</td>
                                        <td>@DisplayValue(lit.Type)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="empty-state-small">Bu bitki i√ßin kayƒ±tlƒ± literat√ºr bulunmuyor.</div>
                    }
                </CollapsibleSection>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private BitkiDetailViewModel? bitki;
    private bool isLoading = true;
    private string? errorMessage;
    private string activeTab = "general";
    private bool isEditMode = false;
    private bool descriptionExpanded = false;

    // Breadcrumb
    private List<Breadcrumb.BreadcrumbItem> breadcrumbItems = new();

    // Lazy loading states
    private bool compoundsLoaded = false;
    private bool compoundsLoading = false;
    private bool imagesLoaded = false;
    private bool imagesLoading = false;
    private bool literatureLoaded = false;
    private bool literatureLoading = false;

    // Helper method for displaying field values
    private MarkupString DisplayValue(string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            return new MarkupString("<span class=\"empty-value\">Bilgi bulunmamaktadƒ±r</span>");
        }
        return new MarkupString(value);
    }

    private async Task SetTab(string tab)
    {
        activeTab = tab;

        // Lazy load data when tab is first clicked
        if (tab == "compounds" && !compoundsLoaded && !compoundsLoading)
        {
            await LoadCompounds();
        }
        else if (tab == "images" && !imagesLoaded && !imagesLoading)
        {
            await LoadImages();
        }
        else if (tab == "literature" && !literatureLoaded && !literatureLoading)
        {
            await LoadLiterature();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reset lazy loading states when ID changes
        compoundsLoaded = false;
        imagesLoaded = false;
        literatureLoaded = false;
        activeTab = "general";
        descriptionExpanded = false;
        isEditMode = false;
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            // Load basic details only (cached on backend)
            bitki = await Http.GetFromJsonAsync<BitkiDetailViewModel>($"api/bitki/{Id}/details/basic");
            if (bitki == null)
            {
                errorMessage = "Bitki bulunamadƒ±.";
            }
            else
            {
                // Update breadcrumb
                breadcrumbItems = new List<Breadcrumb.BreadcrumbItem>
{
new("Bitkiler", "/bitki"),
new(bitki.DisplayName)
};
            }
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            errorMessage = "Bitki bulunamadƒ±.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Veri y√ºklenirken hata olu≈ütu: {ex.Message}";
            Console.WriteLine(ex);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCompounds()
    {
        if (bitki == null) return;

        compoundsLoading = true;
        StateHasChanged();

        try
        {
            var compounds = await Http.GetFromJsonAsync<List<PlantCompoundViewModel>>($"api/bitki/{Id}/compounds");
            bitki.Compounds = compounds ?? new List<PlantCompoundViewModel>();
            compoundsLoaded = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading compounds: {ex.Message}");
        }
        finally
        {
            compoundsLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadImages()
    {
        if (bitki == null) return;

        imagesLoading = true;
        StateHasChanged();

        try
        {
            var images = await Http.GetFromJsonAsync<List<PlantImageViewModel>>($"api/bitki/{Id}/images");
            bitki.Images = images ?? new List<PlantImageViewModel>();
            imagesLoaded = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading images: {ex.Message}");
        }
        finally
        {
            imagesLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadLiterature()
    {
        if (bitki == null) return;

        literatureLoading = true;
        StateHasChanged();

        try
        {
            var literature = await Http.GetFromJsonAsync<List<PlantLiteratureViewModel>>($"api/bitki/{Id}/literature");
            bitki.Literature = literature ?? new List<PlantLiteratureViewModel>();
            literatureLoaded = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading literature: {ex.Message}");
        }
        finally
        {
            literatureLoading = false;
            StateHasChanged();
        }
    }

    private void EnableEditMode()
    {
        isEditMode = true;
    }

    private void CancelEdit()
    {
        isEditMode = false;
    }

    private async Task SaveChanges()
    {
        // TODO: Implement save logic via API
        isEditMode = false;
    }
}