@page "/bitki/{Id:int}"
@rendermode InteractiveServer
@using Bitki.Blazor.Models
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>@(bitki?.DisplayName ?? "Bitki Detay")</PageTitle>

<div class="detail-page">
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">@errorMessage</div>
        <a href="/bitki" class="btn btn-secondary">â† Listeye DÃ¶n</a>
    }
    else if (bitki != null)
    {
        <!-- Header Section -->
        <div class="detail-header">
            <a href="/bitki" class="back-link">â† Bitkiler</a>
            <div class="header-content">
                <h1>@bitki.DisplayName</h1>
                @if (!string.IsNullOrEmpty(bitki.LatinName) && bitki.LatinName != bitki.TurkishName)
                {
                    <div class="latin-name">@bitki.LatinName</div>
                }
                <div class="taxonomy-badge">
                    <span class="badge-item">Familya: @(bitki.FamilyName ?? "â€”")</span>
                    <span class="badge-item">Genus: @(bitki.GenusName ?? "â€”")</span>
                    <span class="badge-item">ID: @bitki.Id</span>
                </div>
            </div>
        </div>

        <!-- Flags Row -->
        <div class="flags-row">
            @if (bitki.IsMedicinal)
            {
                <span class="flag medicinal">ğŸ’Š TÄ±bbi</span>
            }
            @if (bitki.IsFood)
            {
                <span class="flag food">ğŸƒ GÄ±da</span>
            }
            @if (bitki.IsCultural)
            {
                <span class="flag cultural">ğŸŒ± KÃ¼ltÃ¼r</span>
            }
            @if (bitki.IsPoisonous)
            {
                <span class="flag poisonous">â˜ ï¸ Zehirli</span>
            }
            @if (bitki.IsTurkishFlora)
            {
                <span class="flag flora">ğŸ‡¹ğŸ‡· TF</span>
            }
            @if (bitki.IsExtinct)
            {
                <span class="flag extinct">âŒ Yok OlmuÅŸ</span>
            }
            @if (bitki.IsIslandSpecies)
            {
                <span class="flag island">ğŸï¸ Ada</span>
            }
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-btn @(activeTab == "general" ? "active" : "")" @onclick="@(() => SetTab("general"))">
                Genel Bilgiler
            </button>
            <button class="tab-btn @(activeTab == "taxonomy" ? "active" : "")" @onclick="@(() => SetTab("taxonomy"))">
                Taksonomi
            </button>
            <button class="tab-btn @(activeTab == "ecology" ? "active" : "")" @onclick="@(() => SetTab("ecology"))">
                Ekoloji & DaÄŸÄ±lÄ±m
            </button>
            <button class="tab-btn @(activeTab == "compounds" ? "active" : "")" @onclick="@(() => SetTab("compounds"))">
                BileÅŸikler (@bitki.Compounds.Count)
            </button>
            <button class="tab-btn @(activeTab == "images" ? "active" : "")" @onclick="@(() => SetTab("images"))">
                GÃ¶rseller (@bitki.Images.Count)
            </button>
            <button class="tab-btn @(activeTab == "literature" ? "active" : "")" @onclick="@(() => SetTab("literature"))">
                LiteratÃ¼r (@bitki.Literature.Count)
            </button>
        </div>


        <!-- Tab Content -->
        <div class="tab-content">
            @if (activeTab == "general")
            {
                <div class="detail-section">
                    <h3>Genel Bilgiler</h3>
                    <div class="fields-grid">
                        <div class="field-item">
                            <span class="field-label">TÃ¼rkÃ§e Ad</span>
                            <span class="field-value">@(bitki.TurkishName ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">Latince Ad</span>
                            <span class="field-value">@(bitki.LatinName ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">Yerel Adlar</span>
                            <span class="field-value">@(bitki.CommonNames ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">Durum</span>
                            <span class="field-value">@(bitki.Status ?? "â€”")</span>
                        </div>
                    </div>

                    <h4>AÃ§Ä±klama</h4>
                    <div class="description-box">
                        @(bitki.Description ?? "AÃ§Ä±klama bulunmuyor.")
                    </div>

                    @if (!string.IsNullOrEmpty(bitki.Notes))
                    {
                        <h4>Notlar</h4>
                        <div class="description-box">@bitki.Notes</div>
                    }

                    @if (!string.IsNullOrEmpty(bitki.AdditionalInfo))
                    {
                        <h4>Ek Bilgi</h4>
                        <div class="description-box">@bitki.AdditionalInfo</div>
                    }

                    <h4>Bayraklar</h4>
                    <div class="flags-detail-grid">
                        <div class="flag-item @(bitki.IsMedicinal ? "active" : "")">
                            <span class="flag-indicator"></span>TÄ±bbi KullanÄ±m
                        </div>
                        <div class="flag-item @(bitki.IsFood ? "active" : "")">
                            <span class="flag-indicator"></span>GÄ±da Olarak
                        </div>
                        <div class="flag-item @(bitki.IsCultural ? "active" : "")">
                            <span class="flag-indicator"></span>KÃ¼ltÃ¼r Bitkisi
                        </div>
                        <div class="flag-item @(bitki.IsPoisonous ? "active" : "")">
                            <span class="flag-indicator"></span>Zehirli
                        </div>
                        <div class="flag-item @(bitki.IsTurkishFlora ? "active" : "")">
                            <span class="flag-indicator"></span>TÃ¼rkiye FlorasÄ±
                        </div>
                        <div class="flag-item @(bitki.IsIslandSpecies ? "active" : "")">
                            <span class="flag-indicator"></span>Ada TÃ¼rÃ¼
                        </div>
                        <div class="flag-item @(bitki.ExistenceDoubtful ? "active" : "")">
                            <span class="flag-indicator"></span>VarlÄ±k ÅÃ¼pheli
                        </div>
                        <div class="flag-item @(bitki.NeedsRevision ? "active" : "")">
                            <span class="flag-indicator"></span>Revizyon Gerekli
                        </div>
                        <div class="flag-item @(bitki.IsExtinct ? "active" : "")">
                            <span class="flag-indicator"></span>Yok OlmuÅŸ
                        </div>
                        <div class="flag-item @(bitki.IncompleteIdentification ? "active" : "")">
                            <span class="flag-indicator"></span>Eksik TeÅŸhis
                        </div>
                        <div class="flag-item @(bitki.ControlOk ? "active" : "")">
                            <span class="flag-indicator"></span>Kontrol OK
                        </div>
                        <div class="flag-item @(bitki.PublicationOk ? "active" : "")">
                            <span class="flag-indicator"></span>YayÄ±n OK
                        </div>
                    </div>
                </div>
            }
            else if (activeTab == "taxonomy")
            {
                <div class="detail-section">
                    <h3>Taksonomi Bilgileri</h3>
                    <div class="fields-grid">
                        <div class="field-item">
                            <span class="field-label">Familya</span>
                            <span class="field-value">@(bitki.FamilyName ?? "â€”")
                                @(!string.IsNullOrEmpty(bitki.FamilyTurkishName) ? $"({bitki.FamilyTurkishName})" : "")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">Genus</span>
                            <span class="field-value">@(bitki.GenusName ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">Takson AdÄ±</span>
                            <span class="field-value">@(bitki.TaxonName ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">Takson DÃ¼zeyi</span>
                            <span class="field-value">@(bitki.TaxonLevel ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">Takson Cinsi</span>
                            <span class="field-value">@(bitki.TaxonKind ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">Takson OtÃ¶rÃ¼</span>
                            <span class="field-value">@(bitki.TaxonOtor ?? "â€”")</span>
                        </div>
                    </div>

                    <h4>OtÃ¶r Bilgileri</h4>
                    <div class="fields-grid">
                        <div class="field-item">
                            <span class="field-label">OtÃ¶r</span>
                            <span class="field-value">@(bitki.Otor ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">Basionim OtÃ¶r</span>
                            <span class="field-value">@(bitki.BasionymOtor ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">YÄ±l</span>
                            <span class="field-value">@(bitki.Year ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">Sayfa</span>
                            <span class="field-value">@(bitki.Pages ?? "â€”")</span>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(bitki.Synonym))
                    {
                        <h4>Sinonim Bilgileri</h4>
                        <div class="fields-grid">
                            <div class="field-item">
                                <span class="field-label">Sinonim</span>
                                <span class="field-value">@bitki.Synonym</span>
                            </div>
                            <div class="field-item">
                                <span class="field-label">Sinonim OtÃ¶r</span>
                                <span class="field-value">@(bitki.SynonymOtor ?? "â€”")</span>
                            </div>
                        </div>
                    }
                </div>
            }
            else if (activeTab == "ecology")
            {
                <div class="detail-section">
                    <h3>Ekoloji & DaÄŸÄ±lÄ±m</h3>
                    <div class="fields-grid">
                        <div class="field-item">
                            <span class="field-label">Endemizm</span>
                            <span class="field-value">@(bitki.Endemism ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">Endemizm AÃ§Ä±klama</span>
                            <span class="field-value">@(bitki.EndemismDescription ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">Ã‡iÃ§eklenme ZamanÄ±</span>
                            <span class="field-value">@(bitki.FloweringTime ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">RakÄ±m/YÃ¼kseklik</span>
                            <span class="field-value">@(bitki.Altitude ?? "â€”")</span>
                        </div>
                        <div class="field-item">
                            <span class="field-label">FitocoÄŸrafya</span>
                            <span class="field-value">@(bitki.Phytogeography ?? "â€”")</span>
                        </div>
                    </div>

                    <h4>YaÅŸam AlanÄ±</h4>
                    <div class="description-box">
                        @(bitki.Habitat ?? "Habitat bilgisi bulunmuyor.")
                    </div>

                    <h4>DaÄŸÄ±lÄ±m</h4>
                    <div class="description-box">
                        @(bitki.Distribution ?? "DaÄŸÄ±lÄ±m bilgisi bulunmuyor.")
                    </div>

                    @if (!string.IsNullOrEmpty(bitki.References))
                    {
                        <h4>Kaynaklar</h4>
                        <div class="description-box">@bitki.References</div>
                    }
                </div>
            }
            else if (activeTab == "compounds")
            {
                <div class="detail-section">
                    <h3>BileÅŸikler</h3>
                    @if (bitki.Compounds.Any())
                    {
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th>BileÅŸik AdÄ±</th>
                                    <th>Ä°ngilizce</th>
                                    <th>Latince</th>
                                    <th>Miktar</th>
                                    <th>AÃ§Ä±klama</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var compound in bitki.Compounds)
                                {
                                    <tr>
                                        <td>@(compound.CompoundName ?? "â€”")</td>
                                        <td>@(compound.CompoundEnglishName ?? "â€”")</td>
                                        <td>@(compound.CompoundLatinName ?? "â€”")</td>
                                        <td>@(compound.Amount?.ToString("F2") ?? "â€”")</td>
                                        <td>@(compound.Description ?? "â€”")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="empty-state-small">Bu bitki iÃ§in kayÄ±tlÄ± bileÅŸik bulunmuyor.</div>
                    }
                </div>
            }
            else if (activeTab == "images")
            {
                <div class="detail-section">
                    <h3>GÃ¶rseller</h3>
                    @if (bitki.Images.Any())
                    {
                        <div class="image-grid">
                            @foreach (var image in bitki.Images)
                            {
                                <div class="image-card">
                                    <div class="image-placeholder-box">ğŸ“·</div>
                                    <div class="image-info">
                                        <div class="image-path">@image.ImageLocation</div>
                                        @if (!string.IsNullOrEmpty(image.Description))
                                        {
                                            <div class="image-desc">@image.Description</div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-state-small">Bu bitki iÃ§in kayÄ±tlÄ± gÃ¶rsel bulunmuyor.</div>
                    }
                </div>
            }
            else if (activeTab == "literature")
            {
                <div class="detail-section">
                    <h3>LiteratÃ¼r</h3>
                    @if (bitki.Literature.Any())
                    {
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th>Yazar</th>
                                    <th>AraÅŸtÄ±rma AdÄ±</th>
                                    <th>Kaynak</th>
                                    <th>YÄ±l</th>
                                    <th>TÃ¼r</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var lit in bitki.Literature)
                                {
                                    <tr>
                                        <td>@(lit.AuthorName ?? "â€”")</td>
                                        <td>@(lit.ResearchName ?? "â€”")</td>
                                        <td>@(lit.SourceName ?? "â€”")</td>
                                        <td>@(lit.Year?.ToString() ?? "â€”")</td>
                                        <td>@(lit.Type ?? "â€”")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="empty-state-small">Bu bitki iÃ§in kayÄ±tlÄ± literatÃ¼r bulunmuyor.</div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private BitkiDetailViewModel? bitki;
    private bool isLoading = true;
    private string? errorMessage;
    private string activeTab = "general";

    private void SetTab(string tab)
    {
        activeTab = tab;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }


    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            bitki = await Http.GetFromJsonAsync<BitkiDetailViewModel>($"api/bitki/{Id}/details");
            if (bitki == null)
            {
                errorMessage = "Bitki bulunamadÄ±.";
            }
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            errorMessage = "Bitki bulunamadÄ±.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Veri yÃ¼klenirken hata oluÅŸtu: {ex.Message}";
            Console.WriteLine(ex);
        }
        finally
        {
            isLoading = false;
        }
    }
}