@page "/bitki/{Id:int}"
@rendermode InteractiveServer
@using Bitki.Blazor.Models
@using global::Bitki.Blazor.Services
@using global::Bitki.Core.Entities
@using Bitki.Blazor.Components.Common
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>@(bitki?.DisplayName ?? "Bitki Detay")</PageTitle>

<div class="detail-page @(isEditMode ? "edit-mode" : "")">
    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Y√ºkleniyor...</span>
            </div>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">@errorMessage</div>
        <a href="/bitki" class="btn btn-secondary">‚Üê Listeye D√∂n</a>
    }
    else if (bitki != null)
    {
        @* Admin Action Bar *@
        <AuthorizeView Roles="Admin">
            <Authorized>
                @if (isEditMode)
                {
                    <div class="action-bar">
                        <button class="btn btn-success" @onclick="SaveChanges">Kaydet</button>
                        <button class="btn btn-secondary" @onclick="CancelEdit">ƒ∞ptal</button>
                    </div>
                }
            </Authorized>
        </AuthorizeView>

        @* Breadcrumb Navigation *@
        <Breadcrumb Items="@breadcrumbItems" />

        @* Header Section *@
        <div class="detail-header">
            <div class="header-content">
                @if (!isEditMode)
                {
                    <h1>@bitki.DisplayName</h1>
                    @if (!string.IsNullOrEmpty(bitki.LatinName) && bitki.LatinName != bitki.TurkishName)
                    {
                        <div class="latin-name">@bitki.LatinName</div>
                    }
                }
                else
                {
                    <div class="edit-header-inputs">
                        <InputText @bind-Value="editModel.Name" class="form-control form-control-lg mb-2"
                            placeholder="T√ºrk√ße Ad" />
                        <InputText @bind-Value="editModel.LatinName" class="form-control mb-2" placeholder="Latince Ad" />
                    </div>
                }
                <div class="metadata-row">
                    <AuthorizeView Roles="Admin">
                        <Authorized>
                            <span class="metadata-badge id-badge">ID: @bitki.Id</span>
                        </Authorized>
                    </AuthorizeView>
                    @if (!string.IsNullOrEmpty(bitki.FamilyName))
                    {
                        <span class="metadata-badge">@bitki.FamilyName</span>
                    }
                    @if (!string.IsNullOrEmpty(bitki.GenusName))
                    {
                        <span class="metadata-badge">@bitki.GenusName</span>
                    }
                    @if (!string.IsNullOrEmpty(bitki.Status))
                    {
                        <span class="metadata-badge">@bitki.Status</span>
                    }
                    <AuthorizeView Roles="Admin">
                        <Authorized>
                            @if (!isEditMode)
                            {
                                <button class="btn btn-sm btn-outline-primary" @onclick="EnableEditMode">D√ºzenle</button>
                            }
                        </Authorized>
                    </AuthorizeView>
                </div>
            </div>
        </div>

        @* Flags Row *@
        <div class="flags-row">
            @if (bitki.IsMedicinal)
            {
                <span class="flag medicinal">üíä Tƒ±bbi</span>
            }
            @if (bitki.IsFood)
            {
                <span class="flag food">üçÉ Gƒ±da</span>
            }
            @if (bitki.IsCultural)
            {
                <span class="flag cultural">üå± K√ºlt√ºr</span>
            }
            @if (bitki.IsPoisonous)
            {
                <span class="flag poisonous">‚ò†Ô∏è Zehirli</span>
            }
            @if (bitki.IsTurkishFlora)
            {
                <span class="flag flora">üáπüá∑ TF</span>
            }
            @if (bitki.IsExtinct)
            {
                <span class="flag extinct">‚ùå Yok Olmu≈ü</span>
            }
            @if (bitki.IsIslandSpecies)
            {
                <span class="flag island">üèùÔ∏è Ada</span>
            }
        </div>

        @* Tab Navigation *@
        <div class="tab-navigation">
            <button class="tab-btn @(activeTab == "general" ? "active" : "")" @onclick="@(() => SetTab("general"))">
                Genel Bilgiler
            </button>
            <button class="tab-btn @(activeTab == "taxonomy" ? "active" : "")" @onclick="@(() => SetTab("taxonomy"))">
                Taksonomi
            </button>
            <button class="tab-btn @(activeTab == "ecology" ? "active" : "")" @onclick="@(() => SetTab("ecology"))">
                Ekoloji & Daƒüƒ±lƒ±m
            </button>
            <button class="tab-btn @(activeTab == "compounds" ? "active" : "")" @onclick="@(() => SetTab("compounds"))">
                Bile≈üikler (@bitki.Compounds.Count)
            </button>
            <button class="tab-btn @(activeTab == "images" ? "active" : "")" @onclick="@(() => SetTab("images"))">
                G√∂rseller (@bitki.Images.Count)
            </button>
            <button class="tab-btn @(activeTab == "literature" ? "active" : "")" @onclick="@(() => SetTab("literature"))">
                Literat√ºr (@bitki.Literature.Count)
            </button>
        </div>

        @* Tab Content *@
        <div class="tab-content">
            @if (activeTab == "general")
            {
                <CollapsibleSection Title="Temel Bilgiler">
                    <div class="field-grid">
                        <span class="field-label">T√ºrk√ße Ad</span>
                        @if (!isEditMode)
                        {
                            <span class="field-value">@DisplayValue(bitki.TurkishName)</span>
                        }
                        else
                        {
                            <InputText @bind-Value="editModel.Name" class="form-control form-control-sm" />
                        }

                        <span class="field-label">Latince Ad</span>
                        @if (!isEditMode)
                        {
                            <span class="field-value">@DisplayValue(bitki.LatinName)</span>
                        }
                        else
                        {
                            <InputText @bind-Value="editModel.LatinName" class="form-control form-control-sm" />
                        }

                        <span class="field-label">Yerel Adlar</span>
                        @if (!isEditMode)
                        {
                            <span class="field-value">@DisplayValue(bitki.CommonNames)</span>
                        }
                        else
                        {
                            <InputText @bind-Value="editModel.CommonNames" class="form-control form-control-sm" />
                        }

                        <span class="field-label">Durum</span>
                        <span class="field-value">@DisplayValue(bitki.Status)</span>
                    </div>
                </CollapsibleSection>

                <CollapsibleSection Title="A√ßƒ±klama">
                    @if (!isEditMode)
                    {
                        @if (!string.IsNullOrEmpty(bitki.Description))
                        {
                            @if (bitki.Description.Length > 300)
                            {
                                <div class="long-text-container">
                                    <div class="description-box long-text-content @(descriptionExpanded ? "expanded" : "")">
                                        @bitki.Description
                                    </div>
                                    @if (!descriptionExpanded)
                                    {
                                        <div class="long-text-gradient"></div>
                                    }
                                    <button class="show-more-btn" @onclick="@(() => descriptionExpanded = !descriptionExpanded)">
                                        @(descriptionExpanded ? "Daha az g√∂ster" : "Daha fazla g√∂ster")
                                    </button>
                                </div>
                            }
                            else
                            {
                                <div class="description-box">@bitki.Description</div>
                            }
                        }
                        else
                        {
                            <span class="empty-value">Bilgi bulunmamaktadƒ±r</span>
                        }
                    }
                    else
                    {
                        <InputTextArea @bind-Value="editModel.Description" class="form-control" rows="6" />
                    }
                </CollapsibleSection>

                @if (!string.IsNullOrEmpty(bitki.Notes) || !string.IsNullOrEmpty(bitki.AdditionalInfo))
                {
                    <CollapsibleSection Title="Ek Notlar" DefaultExpanded="false">
                        @if (!string.IsNullOrEmpty(bitki.Notes))
                        {
                            <h4>Notlar</h4>
                            <div class="description-box">@bitki.Notes</div>
                        }
                        @if (!string.IsNullOrEmpty(bitki.AdditionalInfo))
                        {
                            <h4>Ek Bilgi</h4>
                            <div class="description-box">@bitki.AdditionalInfo</div>
                        }
                    </CollapsibleSection>
                }

                <CollapsibleSection Title="√ñzellikler" DefaultExpanded="false">
                    <div class="flags-detail-grid @(isEditMode ? "edit-flags" : "")">
                        @if (!isEditMode)
                        {
                            <div class="flag-item @(bitki.IsMedicinal ? "active" : "")"><span class="flag-indicator"></span>Tƒ±bbi
                                Kullanƒ±m</div>
                            <div class="flag-item @(bitki.IsFood ? "active" : "")"><span class="flag-indicator"></span>Gƒ±da Olarak
                            </div>
                            <div class="flag-item @(bitki.IsCultural ? "active" : "")"><span class="flag-indicator"></span>K√ºlt√ºr
                                Bitkisi</div>
                            <div class="flag-item @(bitki.IsPoisonous ? "active" : "")"><span class="flag-indicator"></span>Zehirli
                            </div>
                            <div class="flag-item @(bitki.IsTurkishFlora ? "active" : "")"><span
                                    class="flag-indicator"></span>T√ºrkiye Florasƒ±</div>
                            <div class="flag-item @(bitki.IsIslandSpecies ? "active" : "")"><span class="flag-indicator"></span>Ada
                                T√ºr√º</div>
                            <div class="flag-item @(bitki.ExistenceDoubtful ? "active" : "")"><span
                                    class="flag-indicator"></span>Varlƒ±k ≈û√ºpheli</div>
                            <div class="flag-item @(bitki.NeedsRevision ? "active" : "")"><span
                                    class="flag-indicator"></span>Revizyon Gerekli</div>
                            <div class="flag-item @(bitki.IsExtinct ? "active" : "")"><span class="flag-indicator"></span>Yok Olmu≈ü
                            </div>
                            <div class="flag-item @(bitki.IncompleteIdentification ? "active" : "")"><span
                                    class="flag-indicator"></span>Eksik Te≈ühis</div>
                            <div class="flag-item @(bitki.ControlOk ? "active" : "")"><span class="flag-indicator"></span>Kontrol OK
                            </div>
                            <div class="flag-item @(bitki.PublicationOk ? "active" : "")"><span class="flag-indicator"></span>Yayƒ±n
                                OK</div>
                        }
                        else
                        {
                            <label class="flag-checkbox">
                                <InputCheckbox @bind-Value="editModel.IsMedicinal" /> Tƒ±bbi Kullanƒ±m
                            </label>
                            <label class="flag-checkbox">
                                <InputCheckbox @bind-Value="editModel.IsFood" /> Gƒ±da Olarak
                            </label>
                            <label class="flag-checkbox">
                                <InputCheckbox @bind-Value="editModel.IsCultural" /> K√ºlt√ºr Bitkisi
                            </label>
                            <label class="flag-checkbox">
                                <InputCheckbox @bind-Value="editModel.IsPoisonous" /> Zehirli
                            </label>
                            <label class="flag-checkbox">
                                <InputCheckbox @bind-Value="editModel.IsTurkishFlora" /> T√ºrkiye Florasƒ±
                            </label>
                            <label class="flag-checkbox">
                                <InputCheckbox @bind-Value="editModel.IsIslandSpecies" /> Ada T√ºr√º
                            </label>
                            <label class="flag-checkbox">
                                <InputCheckbox @bind-Value="editModel.ExistenceDoubtful" /> Varlƒ±k ≈û√ºpheli
                            </label>
                            <label class="flag-checkbox">
                                <InputCheckbox @bind-Value="editModel.NeedsRevision" /> Revizyon Gerekli
                            </label>
                            <label class="flag-checkbox warning">
                                <InputCheckbox @bind-Value="editModel.IsExtinct" /> Yok Olmu≈ü
                            </label>
                            <label class="flag-checkbox">
                                <InputCheckbox @bind-Value="editModel.IncompleteIdentification" /> Eksik Te≈ühis
                            </label>
                            <label class="flag-checkbox">
                                <InputCheckbox @bind-Value="editModel.ControlOk" /> Kontrol OK
                            </label>
                            <label class="flag-checkbox">
                                <InputCheckbox @bind-Value="editModel.PublicationOk" /> Yayƒ±n OK
                            </label>
                        }
                    </div>
                </CollapsibleSection>
            }
            else if (activeTab == "taxonomy")
            {
                <CollapsibleSection Title="Sƒ±nƒ±flandƒ±rma">
                    <div class="field-grid">
                        <span class="field-label">Familya</span>
                        <span class="field-value">
                            @if (!isEditMode)
                            {
                                @DisplayValue(bitki.FamilyName)
                                @if (!string.IsNullOrEmpty(bitki.FamilyTurkishName))
                                {
                                    <span class="text-muted"> (@bitki.FamilyTurkishName)</span>
                                }
                            }
                            else
                            {
                                <span class="text-muted">Genus se√ßimine g√∂re otomatik belirlenir (@bitki.FamilyName)</span>
                            }
                        </span>

                        <span class="field-label">Genus</span>
                        @if (!isEditMode)
                        {
                            <span class="field-value">@DisplayValue(bitki.GenusName)</span>
                        }
                        else
                        {
                            <InputSelect @bind-Value="editModel.GenusId" class="form-control form-control-sm">
                                <option value="">Se√ßiniz...</option>
                                @foreach (var g in genera)
                                {
                                    <option value="@((int)g.Id)">@g.Name</option>
                                }
                            </InputSelect>
                        }

                        <span class="field-label">Takson Adƒ±</span>
                        @if (!isEditMode)
                        {
                            <span class="field-value">@DisplayValue(bitki.TaxonName)</span>
                        }
                        else
                        {
                            <InputText @bind-Value="editModel.TaxonName" class="form-control form-control-sm" />
                        }

                        <span class="field-label">Takson D√ºzeyi</span>
                        <span class="field-value">@DisplayValue(bitki.TaxonLevel)</span>

                        <span class="field-label">Takson Cinsi</span>
                        @if (!isEditMode)
                        {
                            <span class="field-value">@DisplayValue(bitki.TaxonKind)</span>
                        }
                        else
                        {
                            <InputText @bind-Value="editModel.TaxonKind" class="form-control form-control-sm" />
                        }

                        <span class="field-label">Takson Ot√∂r√º</span>
                        @if (!isEditMode)
                        {
                            <span class="field-value">@DisplayValue(bitki.TaxonOtor)</span>
                        }
                        else
                        {
                            <span class="field-value text-muted">Otomatiktir</span>
                        }
                    </div>
                </CollapsibleSection>

                <CollapsibleSection Title="Ot√∂r Bilgileri">
                    <div class="field-grid">
                        <span class="field-label">Ot√∂r</span>
                        <span class="field-value">@DisplayValue(bitki.Otor)</span>

                        <span class="field-label">Basionim Ot√∂r</span>
                        <span class="field-value">@DisplayValue(bitki.BasionymOtor)</span>

                        <span class="field-label">Yƒ±l</span>
                        <span class="field-value">@DisplayValue(bitki.Year)</span>

                        <span class="field-label">Sayfa</span>
                        <span class="field-value">@DisplayValue(bitki.Pages)</span>
                    </div>
                </CollapsibleSection>

                @if (!string.IsNullOrEmpty(bitki.Synonym))
                {
                    <CollapsibleSection Title="Sinonim Bilgileri" DefaultExpanded="false">
                        <div class="field-grid">
                            <span class="field-label">Sinonim</span>
                            <span class="field-value">@bitki.Synonym</span>

                            <span class="field-label">Sinonim Ot√∂r</span>
                            <span class="field-value">@DisplayValue(bitki.SynonymOtor)</span>
                        </div>
                    </CollapsibleSection>
                }
            }
            else if (activeTab == "ecology")
            {
                <CollapsibleSection Title="Endemizm & Fitocoƒürafya">
                    <div class="field-grid">
                        <span class="field-label">Endemizm</span>
                        @if (!isEditMode)
                        {
                            <span class="field-value">@DisplayValue(bitki.Endemism)</span>
                        }
                        else
                        {
                            <InputText @bind-Value="editModel.Endemism" class="form-control form-control-sm" />
                        }

                        <span class="field-label">Endemizm A√ßƒ±klama</span>
                        @if (!isEditMode)
                        {
                            <span class="field-value">@DisplayValue(bitki.EndemismDescription)</span>
                        }
                        else
                        {
                            <InputText @bind-Value="editModel.EndemismDescription" class="form-control form-control-sm" />
                        }

                        <span class="field-label">Fitocoƒürafya</span>
                        @if (!isEditMode)
                        {
                            <span class="field-value">@DisplayValue(bitki.Phytogeography)</span>
                        }
                        else
                        {
                            <InputText @bind-Value="editModel.Phytogeography" class="form-control form-control-sm" />
                        }

                        <span class="field-label">√ái√ßeklenme Zamanƒ±</span>
                        @if (!isEditMode)
                        {
                            <span class="field-value">@DisplayValue(bitki.FloweringTime)</span>
                        }
                        else
                        {
                            <div class="d-flex gap-2">
                                <InputNumber @bind-Value="editModel.FirstFloweringTime" class="form-control form-control-sm"
                                    placeholder="Ba≈ülangƒ±√ß Ayƒ± (1-12)" />
                                <span class="align-self-center">-</span>
                                <InputNumber @bind-Value="editModel.LastFloweringTime" class="form-control form-control-sm"
                                    placeholder="Biti≈ü Ayƒ± (1-12)" />
                            </div>
                        }

                        <span class="field-label">Rakƒ±m/Y√ºkseklik</span>
                        @if (!isEditMode)
                        {
                            <span class="field-value">@DisplayValue(bitki.Altitude)</span>
                        }
                        else
                        {
                            <div class="d-flex gap-2">
                                <InputNumber @bind-Value="editModel.MinAltitude" class="form-control form-control-sm"
                                    placeholder="Min (m)" />
                                <span class="align-self-center">-</span>
                                <InputNumber @bind-Value="editModel.MaxAltitude" class="form-control form-control-sm"
                                    placeholder="Max (m)" />
                            </div>
                        }
                    </div>
                </CollapsibleSection>

                <CollapsibleSection Title="Ya≈üam Alanƒ±">
                    @if (!isEditMode)
                    {
                        @if (!string.IsNullOrEmpty(bitki.Habitat))
                        {
                            <div class="description-box">@bitki.Habitat</div>
                        }
                        else
                        {
                            <span class="empty-value">Bilgi bulunmamaktadƒ±r</span>
                        }
                    }
                    else
                    {
                        <InputTextArea @bind-Value="editModel.Habitat" class="form-control" rows="3" />
                    }
                </CollapsibleSection>

                <CollapsibleSection Title="Daƒüƒ±lƒ±m">
                    @if (!isEditMode)
                    {
                        @if (!string.IsNullOrEmpty(bitki.Distribution))
                        {
                            <div class="description-box">@bitki.Distribution</div>
                        }
                        else
                        {
                            <span class="empty-value">Bilgi bulunmamaktadƒ±r</span>
                        }
                    }
                    else
                    {
                        <InputTextArea @bind-Value="editModel.DistributionTurkey" class="form-control" rows="3"
                            placeholder="T√ºrkiye Daƒüƒ±lƒ±mƒ±" />
                        <InputTextArea @bind-Value="editModel.DistributionWorld" class="form-control mt-2" rows="3"
                            placeholder="D√ºnya Daƒüƒ±lƒ±mƒ±" />
                    }
                </CollapsibleSection>

                @if (!string.IsNullOrEmpty(bitki.References))
                {
                    <CollapsibleSection Title="Kaynaklar" DefaultExpanded="false">
                        <div class="description-box">@bitki.References</div>
                    </CollapsibleSection>
                }
            }
            else if (activeTab == "compounds")
            {
                <CollapsibleSection Title="Bile≈üikler">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span></span>
                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <button class="btn btn-sm btn-success" @onclick="OpenAddCompoundModal">
                                    <span>‚ûï</span> Bile≈üik Ekle
                                </button>
                            </Authorized>
                        </AuthorizeView>
                    </div>

                    @if (compoundsLoading)
                    {
                        <div class="tab-loading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span>Bile≈üikler y√ºkleniyor...</span>
                        </div>
                    }
                    else if (bitki.Compounds.Any())
                    {
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th>Bile≈üik Adƒ±</th>
                                    <th>ƒ∞ngilizce</th>
                                    <th>Latince</th>
                                    <th>Miktar</th>
                                    <th>A√ßƒ±klama</th>
                                    <AuthorizeView Roles="Admin">
                                        <Authorized>
                                            <th class="text-end" style="width: 50px;"></th>
                                        </Authorized>
                                    </AuthorizeView>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var compound in bitki.Compounds)
                                {
                                    <tr>
                                        <td>
                                            <a href="/bilesikler/@compound.CompoundId" class="text-decoration-none">
                                                @DisplayValue(compound.CompoundName)
                                            </a>
                                        </td>
                                        <td>@DisplayValue(compound.CompoundEnglishName)</td>
                                        <td>@DisplayValue(compound.CompoundLatinName)</td>
                                        <td>@(compound.Amount?.ToString("F2") ?? "‚Äî")</td>
                                        <td>@DisplayValue(compound.Description)</td>
                                        <AuthorizeView Roles="Admin">
                                            <Authorized>
                                                <td class="text-end">
                                                    <button class="btn btn-link text-danger p-0"
                                                        @onclick="() => DeleteCompound(compound)" title="ƒ∞li≈ükiyi Sil">
                                                        ‚ùå
                                                    </button>
                                                </td>
                                            </Authorized>
                                        </AuthorizeView>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="empty-state-small">Bu bitki i√ßin kayƒ±tlƒ± bile≈üik bulunmuyor.</div>
                    }
                </CollapsibleSection>
            }
            else if (activeTab == "images")
            {
                <CollapsibleSection Title="G√∂rseller">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span></span>
                        <AuthorizeView Roles="Admin">
                            <Authorized>
                                <button class="btn btn-sm btn-success" @onclick="OpenAddImageModal">
                                    <span>‚ûï</span> G√∂rsel Ekle
                                </button>
                            </Authorized>
                        </AuthorizeView>
                    </div>

                    @if (imagesLoading)
                    {
                        <div class="tab-loading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span>G√∂rseller y√ºkleniyor...</span>
                        </div>
                    }
                    else if (bitki.Images.Any())
                    {
                        <div class="image-grid">
                            @foreach (var image in bitki.Images)
                            {
                                <div class="image-card">
                                    <AuthorizeView Roles="Admin">
                                        <Authorized>
                                            <button class="delete-btn-overlay" @onclick="() => DeleteImage(image)">‚ùå</button>
                                        </Authorized>
                                    </AuthorizeView>
                                    <div class="image-placeholder-box">üì∑</div>
                                    <div class="image-info">
                                        <div class="image-path">@image.ImageLocation</div>
                                        @if (!string.IsNullOrEmpty(image.Description))
                                        {
                                            <div class="image-desc">@image.Description</div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-state-small">Bu bitki i√ßin kayƒ±tlƒ± g√∂rsel bulunmuyor.</div>
                    }
                </CollapsibleSection>
            }
            else if (activeTab == "literature")
            {
                <CollapsibleSection Title="Literat√ºr">
                    @if (literatureLoading)
                    {
                        <div class="tab-loading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span>Literat√ºr y√ºkleniyor...</span>
                        </div>
                    }
                    else if (bitki.Literature.Any())
                    {
                        <table class="detail-table">
                            <thead>
                                <tr>
                                    <th>Yazar</th>
                                    <th>Ara≈ütƒ±rma Adƒ±</th>
                                    <th>Kaynak</th>
                                    <th>Yƒ±l</th>
                                    <th>T√ºr</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var lit in bitki.Literature)
                                {
                                    <tr>
                                        <td>@DisplayValue(lit.AuthorName)</td>
                                        <td>@DisplayValue(lit.ResearchName)</td>
                                        <td>@DisplayValue(lit.SourceName)</td>
                                        <td>@(lit.Year?.ToString() ?? "‚Äî")</td>
                                        <td>@DisplayValue(lit.Type)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="empty-state-small">Bu bitki i√ßin kayƒ±tlƒ± literat√ºr bulunmuyor.</div>
                    }
                </CollapsibleSection>
            }
        </div>
    }
</div>

@* Add Compound Modal *@
@if (showAddCompoundModal)
{
    <div class="modal-overlay"
        style="display:block; background-color: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bile≈üik Ekle</h5>
                    <button type="button" class="btn-close" @onclick="CloseAddCompoundModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <label class="form-label fw-bold">1. Bile≈üik Se√ß</label>
                        @if (selectedCompound == null)
                        {
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" @bind="compoundSearchQuery" @bind:event="oninput"
                                    @onkeyup="HandleCompoundSearchInput" placeholder="Bile≈üik adƒ± ara..." />
                                <button class="btn btn-outline-secondary" type="button" @onclick="SearchCompounds">Ara</button>
                            </div>

                            @if (isSearchingCompounds)
                            {
                                <div class="text-center py-2"><small class="text-muted">Aranƒ±yor...</small></div>
                            }
                            else if (foundCompounds != null && foundCompounds.Any())
                            {
                                <div class="list-group border" style="max-height: 200px; overflow-y: auto;">
                                    @foreach (var c in foundCompounds)
                                    {
                                        <button type="button" class="list-group-item list-group-item-action"
                                            @onclick="() => SelectCompound(c)">
                                            @c.Name <small class="text-muted ms-2">(@c.LatinName)</small>
                                        </button>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="alert alert-success d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Se√ßilen Bile≈üik:</strong> @selectedCompound.Name
                                </div>
                                <button class="btn btn-sm btn-outline-danger" @onclick="ClearSelectedCompound">Deƒüi≈ütir</button>
                            </div>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">2. Detaylar</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label small">Miktar</label>
                                <input type="number" step="0.01" class="form-control" @bind="newCompoundRelation.Amount"
                                    disabled="@(selectedCompound == null)" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">A√ßƒ±klama</label>
                                <input type="text" class="form-control" @bind="newCompoundRelation.Description"
                                    disabled="@(selectedCompound == null)" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddCompoundModal">ƒ∞ptal</button>
                    <button type="button" class="btn btn-success" @onclick="SaveCompoundRelation"
                        disabled="@(selectedCompound == null || isSaving)">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* Add Image Modal *@
@if (showAddImageModal)
{
    <div class="modal-dialog modal-dialog-centered"
        style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1060; min-width: 500px;">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title">G√∂rsel Ekle</h5>
                <button type="button" class="btn-close" @onclick="CloseAddImageModal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Resim Yolu / URL</label>
                    <input type="text" class="form-control" @bind="newImage.ImageLocation" placeholder="/images/..." />
                </div>
                <div class="mb-3">
                    <label class="form-label">A√ßƒ±klama</label>
                    <input type="text" class="form-control" @bind="newImage.Description" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseAddImageModal">ƒ∞ptal</button>
                <button type="button" class="btn btn-success" @onclick="SaveImage" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    Kaydet
                </button>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" style="z-index: 1055;"></div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private BitkiDetailViewModel? bitki;
    private BitkiEditModel editModel = new();
    private List<GenusViewModel> genera = new();
    private List<FamilyaViewModel> families = new();

    private bool isLoading = true;
    private string? errorMessage;
    private string activeTab = "general";
    private bool isEditMode = false;
    private bool descriptionExpanded = false;

    // Breadcrumb
    private List<Breadcrumb.BreadcrumbItem> breadcrumbItems = new();

    // Lazy loading states
    private bool compoundsLoaded = false;
    private bool compoundsLoading = false;
    private bool imagesLoaded = false;
    private bool imagesLoading = false;
    private bool literatureLoaded = false;
    private bool literatureLoading = false;

    // Helper method for displaying field values
    private MarkupString DisplayValue(string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            return new MarkupString("<span class=\"empty-value\">Bilgi bulunmamaktadƒ±r</span>");
        }
        return new MarkupString(value);
    }

    private async Task SetTab(string tab)
    {
        activeTab = tab;

        // Lazy load data when tab is first clicked
        if (tab == "compounds" && !compoundsLoaded && !compoundsLoading)
        {
            await LoadCompounds();
        }
        else if (tab == "images" && !imagesLoaded && !imagesLoading)
        {
            await LoadImages();
        }
        else if (tab == "literature" && !literatureLoaded && !literatureLoading)
        {
            await LoadLiterature();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reset lazy loading states when ID changes
        compoundsLoaded = false;
        imagesLoaded = false;
        literatureLoaded = false;
        activeTab = "general";
        descriptionExpanded = false;
        isEditMode = false;
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            // Load basic details only (cached on backend)
            bitki = await Http.GetFromJsonAsync<BitkiDetailViewModel>($"api/bitki/{Id}/details/basic");
            if (bitki == null)
            {
                errorMessage = "Bitki bulunamadƒ±.";
            }
            else
            {
                // Update breadcrumb
                breadcrumbItems = new List<Breadcrumb.BreadcrumbItem>
{
new("Bitkiler", "/bitki"),
new(bitki.DisplayName)
};
            }
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            errorMessage = "Bitki bulunamadƒ±.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Veri y√ºklenirken hata olu≈ütu: {ex.Message}";
            Console.WriteLine(ex);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCompounds()
    {
        if (bitki == null) return;

        compoundsLoading = true;
        StateHasChanged();

        try
        {
            var compounds = await Http.GetFromJsonAsync<List<PlantCompoundViewModel>>($"api/bitki/{Id}/compounds");
            bitki.Compounds = compounds ?? new List<PlantCompoundViewModel>();
            compoundsLoaded = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading compounds: {ex.Message}");
        }
        finally
        {
            compoundsLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadImages()
    {
        if (bitki == null) return;

        imagesLoading = true;
        StateHasChanged();

        try
        {
            var images = await Http.GetFromJsonAsync<List<PlantImageViewModel>>($"api/bitki/{Id}/images");
            bitki.Images = images ?? new List<PlantImageViewModel>();
            imagesLoaded = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading images: {ex.Message}");
        }
        finally
        {
            imagesLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadLiterature()
    {
        if (bitki == null) return;

        literatureLoading = true;
        StateHasChanged();

        try
        {
            var literature = await Http.GetFromJsonAsync<List<PlantLiteratureViewModel>>($"api/bitki/{Id}/literature");
            bitki.Literature = literature ?? new List<PlantLiteratureViewModel>();
            literatureLoaded = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading literature: {ex.Message}");
        }
        finally
        {
            literatureLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadLookups()
    {
        try
        {
            if (!genera.Any())
            {
                genera = await Http.GetFromJsonAsync<List<GenusViewModel>>("api/genus") ?? new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading lookups: {ex.Message}");
        }
    }

    private async void EnableEditMode()
    {
        if (bitki == null) return;

        // Load lookups if not loaded
        await LoadLookups();

        // Map ViewModel to EditModel
        editModel = new BitkiEditModel
        {
            Id = bitki.Id,
            Name = bitki.TurkishName,
            LatinName = bitki.LatinName,
            Description = bitki.Description,
            GenusId = bitki.GenusId,

            // Flags
            IsMedicinal = bitki.IsMedicinal,
            IsFood = bitki.IsFood,
            IsCultural = bitki.IsCultural,
            IsPoisonous = bitki.IsPoisonous,
            IsTurkishFlora = bitki.IsTurkishFlora,
            IsIslandSpecies = bitki.IsIslandSpecies,
            ExistenceDoubtful = bitki.ExistenceDoubtful,
            NeedsRevision = bitki.NeedsRevision,
            IsExtinct = bitki.IsExtinct,
            IncompleteIdentification = bitki.IncompleteIdentification,
            ControlOk = bitki.ControlOk,
            PublicationOk = bitki.PublicationOk,

            // Ecology
            Endemism = bitki.Endemism,
            EndemismDescription = bitki.EndemismDescription,
            FirstFloweringTime = bitki.FirstFloweringTime,
            LastFloweringTime = bitki.LastFloweringTime,
            Habitat = bitki.Habitat,
            MinAltitude = bitki.MinAltitude,
            MaxAltitude = bitki.MaxAltitude,
            DistributionTurkey = bitki.DistributionTurkey,
            DistributionWorld = bitki.DistributionWorld,
            Phytogeography = bitki.Phytogeography,

            // Taxonomy & Other
            CommonNames = bitki.CommonNames,
            TaxonName = bitki.TaxonName,
            TaxonKind = bitki.TaxonKind
        };

        isEditMode = true;
        StateHasChanged();
    }

    private void CancelEdit()
    {
        isEditMode = false;
        editModel = new();
    }

    private async Task SaveChanges()
    {
        try
        {
            // Map EditModel to Plant entity for API
            var plantToUpdate = new Plant
            {
                Id = editModel.Id,
                Name = editModel.Name,
                LatinName = editModel.LatinName,
                Description = editModel.Description,
                GenusId = editModel.GenusId,

                // Flags
                IsMedicinal = editModel.IsMedicinal,
                IsFood = editModel.IsFood,
                IsCultural = editModel.IsCultural,
                IsPoisonous = editModel.IsPoisonous,
                IsTurkishFlora = editModel.IsTurkishFlora,
                IsIslandSpecies = editModel.IsIslandSpecies,
                ExistenceDoubtful = editModel.ExistenceDoubtful,
                NeedsRevision = editModel.NeedsRevision,
                IsExtinct = editModel.IsExtinct,
                IncompleteIdentification = editModel.IncompleteIdentification,
                ControlOk = editModel.ControlOk,
                PublicationOk = editModel.PublicationOk,

                // Ecology
                Endemism = editModel.Endemism,
                EndemismDescription = editModel.EndemismDescription,
                FirstFloweringTime = editModel.FirstFloweringTime,
                LastFloweringTime = editModel.LastFloweringTime,
                Habitat = editModel.Habitat,
                MinAltitude = editModel.MinAltitude,
                MaxAltitude = editModel.MaxAltitude,
                DistributionTurkey = editModel.DistributionTurkey,
                DistributionWorld = editModel.DistributionWorld,
                Phytogeography = editModel.Phytogeography,

                // Taxonomy & Other
                CommonNames = editModel.CommonNames,
                TaxonName = editModel.TaxonName,
                TaxonKind = editModel.TaxonKind
            };

            var response = await Http.PutAsJsonAsync($"api/bitki/{editModel.Id}", plantToUpdate);

            if (response.IsSuccessStatusCode)
            {
                await LoadData();
                isEditMode = false;
            }
            else
            {
                errorMessage = "Kayƒ±t g√ºncellenirken bir hata olu≈ütu.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Hata: {ex.Message}";
        }
    }
}

// Modals State
private bool showAddCompoundModal = false;
private bool showAddImageModal = false;
private bool isSaving = false;

// Compound Modal Data
private string compoundSearchQuery = "";
private bool isSearchingCompounds = false;
private List<BilesiklerViewModel>? foundCompounds;
    private BilesiklerViewModel? selectedCompound;
    private BitkiBilesikViewModel newCompoundRelation = new();

    // Image Modal Data
    private BitkiResimleri newImage = new();

    [Inject] AuthenticatedHttpClient AuthHttp { get; set; } = default!;
    [Inject] IJSRuntime JS { get; set; } = default!;

    // Compound Actions
    private void OpenAddCompoundModal()
    {
    selectedCompound = null;
    compoundSearchQuery = "";
    foundCompounds = null;
    newCompoundRelation = new BitkiBilesikViewModel { PlantId = Id };
    showAddCompoundModal = true;
    }

    private void CloseAddCompoundModal() => showAddCompoundModal = false;

    private async Task HandleCompoundSearchInput(KeyboardEventArgs e)
    {
    if (e.Key == "Enter") await SearchCompounds();
    }

    private async Task SearchCompounds()
    {
    if (string.IsNullOrWhiteSpace(compoundSearchQuery) || compoundSearchQuery.Length < 2) return;
        isSearchingCompounds=true; try { var filter=new FilterRequest { SearchText=compoundSearchQuery, PageSize=20 };
        var response=await Http.PostAsJsonAsync("api/bilesikler/query", filter); if (response.IsSuccessStatusCode) { var
        result=await response.Content.ReadFromJsonAsync<FilterResponse<BilesiklerViewModel>>();
        foundCompounds = result?.Data.ToList();
        }
        }
        catch (Exception ex)
        {
        Console.WriteLine(ex);
        }
        finally
        {
        isSearchingCompounds = false;
        }
        }

        private void SelectCompound(BilesiklerViewModel compound)
        {
        selectedCompound = compound;
        newCompoundRelation.CompoundId = (int)compound.Id;
        newCompoundRelation.CompoundName = compound.Name;
        }

        private void ClearSelectedCompound()
        {
        selectedCompound = null;
        foundCompounds = null;
        }

        private async Task SaveCompoundRelation()
        {
        if (selectedCompound == null) return;

        // Validation: Prevent duplicates
        if (bitki?.Compounds != null && bitki.Compounds.Any(c => c.CompoundId == selectedCompound.Id))
        {
        await JS.InvokeVoidAsync("alert", "Bu bile≈üik zaten bu bitki ile ili≈ükilendirilmi≈ü!");
        return;
        }

        isSaving = true;
        try
        {
        var response = await AuthHttp.PostAsJsonAsync("api/bitkibilesik", newCompoundRelation);
        if (response.IsSuccessStatusCode)
        {
        await JS.InvokeVoidAsync("alert", "ƒ∞li≈üki ba≈üarƒ±yla eklendi!");
        CloseAddCompoundModal();
        await LoadCompounds(); // Reload list
        }
        else
        {
        await JS.InvokeVoidAsync("alert", $"Hata: {response.StatusCode}");
        }
        }
        catch (Exception ex)
        {
        await JS.InvokeVoidAsync("alert", $"Hata: {ex.Message}");
        }
        finally
        {
        isSaving = false;
        }
        }

        private async Task DeleteCompound(PlantCompoundViewModel item)
        {
        if (!await JS.InvokeAsync<bool>("confirm", $"{item.CompoundName} ili≈ükisini silmek istediƒüinize emin misiniz?"))
            return;

            try
            {
            var response = await AuthHttp.DeleteAsync($"api/bitkibilesik/{item.Id}");
            if (response.IsSuccessStatusCode)
            {
            await LoadCompounds();
            }
            else
            {
            await JS.InvokeVoidAsync("alert", "Silinemedi. Yetkinizi kontrol edin.");
            }
            }
            catch (Exception ex)
            {
            await JS.InvokeVoidAsync("alert", $"Hata: {ex.Message}");
            }
            }

            // Image Actions
            private void OpenAddImageModal()
            {
            newImage = new BitkiResimleri { PlantId = Id };
            showAddImageModal = true;
            }

            private void CloseAddImageModal() => showAddImageModal = false;

            private async Task SaveImage()
            {
            if (string.IsNullOrWhiteSpace(newImage.ImageLocation))
            {
            await JS.InvokeVoidAsync("alert", "Resim yolu zorunludur.");
            return;
            }

            isSaving = true;
            try
            {
            var response = await AuthHttp.PostAsJsonAsync("api/bitkiresimleri", newImage);
            if (response.IsSuccessStatusCode)
            {
            await JS.InvokeVoidAsync("alert", "G√∂rsel ba≈üarƒ±yla eklendi!");
            CloseAddImageModal();
            await LoadImages(); // Reload list
            }
            else
            {
            await JS.InvokeVoidAsync("alert", $"Hata: {response.StatusCode}");
            }
            }
            catch (Exception ex)
            {
            await JS.InvokeVoidAsync("alert", $"Hata: {ex.Message}");
            }
            finally
            {
            isSaving = false;
            }
            }

            private async Task DeleteImage(PlantImageViewModel item)
            {
            if (!await JS.InvokeAsync<bool>("confirm", "Bu g√∂rseli silmek istediƒüinize emin misiniz?")) return;

                try
                {
                var response = await AuthHttp.DeleteAsync($"api/bitkiresimleri/{item.Id}");
                if (response.IsSuccessStatusCode)
                {
                await LoadImages();
                }
                else
                {
                await JS.InvokeVoidAsync("alert", "Silinemedi. Yetkinizi kontrol edin.");
                }
                }
                catch (Exception ex)
                {
                await JS.InvokeVoidAsync("alert", $"Hata: {ex.Message}");
                }
                }
                }