@using Bitki.Blazor.Models

@inject HttpClient Http

<div class="list-group list-group-flush">
    <div class="list-group-item bg-light border-bottom p-2">
        <input type="text" class="form-control form-control-sm" placeholder="Bitki ara..." @oninput="OnSearchInput" />
    </div>

    @if (isLoading)
    {
        <div class="list-group-item text-center p-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
        </div>
    }
    else if (!Items.Any())
    {
        <div class="list-group-item text-muted small text-center p-3">Bitki bulunamadÄ±.</div>
    }
    else
    {
        <div class="overflow-auto custom-scrollbar" style="height: calc(100vh - 160px);">
            @foreach (var item in Items)
            {
                <button type="button"
                    class="list-group-item list-group-item-action border-0 border-bottom py-2 @(SelectedPlantId == item.Id ? "active" : "")"
                    @onclick="@(() => SelectItem(item.Id))">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div class="text-truncate">
                            <span class="fw-bold d-block text-truncate">@item.DisplayName</span>
                            @{
                                var familyDisplay = item.FamilyName ?? item.Family;
                            }
                            @if (!string.IsNullOrEmpty(familyDisplay))
                            {
                                <small class="text-muted d-block small opacity-75">@familyDisplay</small>
                            }
                        </div>
                        <i class="bi bi-chevron-right small opacity-50"></i>
                    </div>
                </button>
            }
        </div>
    }
</div>

@code {
    [Parameter] public int? SelectedPlantId { get; set; }
    [Parameter] public EventCallback<int> OnPlantSelected { get; set; }

    private List<Plant> Items { get; set; } = new();
    private bool isLoading = false;
    private string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadList();
    }

    public async Task Refresh()
    {
        await LoadList();
        StateHasChanged();
    }

    private async Task LoadList()
    {
        isLoading = true;
        try
        {
            var request = new FilterRequest
            {
                PageNumber = 1,
                PageSize = 50000, // Load all plants without pagination limit
                                  // Use SearchText to search across all searchable columns (Name, LatinName, etc.)
                SearchText = searchTerm
            };

            var response = await Http.PostAsJsonAsync("api/Bitki/query", request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<FilterResponse<Plant>>();
                Items = result?.Data?.ToList() ?? new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading plant list: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SelectItem(int id)
    {
        // Always trigger selection to allow refresh/re-selection
        await OnPlantSelected.InvokeAsync(id);
    }

    private System.Timers.Timer? _debounceTimer;
    private void OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        _debounceTimer?.Stop();
        _debounceTimer = new System.Timers.Timer(500);
        _debounceTimer.Elapsed += async (s, args) =>
        {
            _debounceTimer.Stop();
            await InvokeAsync(LoadList);
            await InvokeAsync(StateHasChanged);
        };
        _debounceTimer.Start();
    }
}