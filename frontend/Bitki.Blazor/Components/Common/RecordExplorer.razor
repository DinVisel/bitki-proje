@typeparam TItem
@using Microsoft.AspNetCore.Components.Authorization
@using System.Timers

<div class="record-explorer">
    <div class="record-list-panel">
        <div class="panel-header">
            <h4>@Title</h4>
            <div class="record-count">
                @if (TotalCount.HasValue && FilteredCount.HasValue)
                {
                    @if (TotalCount == FilteredCount)
                    {
                        <text>@TotalCount records</text>
                    }
                    else
                    {
                        <text>@FilteredCount of @TotalCount records</text>
                    }
                }
                else
                {
                    <text>@(Items?.Count() ?? 0) records</text>
                }
            </div>
        </div>

        @if (ShowSearch)
        {
            <div class="search-box">
                <input type="text" class="form-control" placeholder="Search..." @bind="searchTerm"
                    @oninput="HandleSearchInput" />
            </div>
        }

        <div class="record-table-container">
            @if (IsLoading)
            {
                <div class="loading-state">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else if (Items == null || !Items.Any())
            {
                <div class="empty-state">No records found</div>
            }
            else
            {
                <table class="record-table">
                    <thead>
                        <tr>
                            @foreach (var column in Columns)
                            {
                                <th @onclick="() => HandleSortClick(column.PropertyName)">
                                    @column.Title
                                    @if (CurrentSortColumn == column.PropertyName)
                                    {
                                        <span class="sort-indicator">@(CurrentSortAscending ? "▲" : "▼")</span>
                                    }
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Items)
                        {
                            var isSelected = SelectedItem?.Equals(item) ?? false;
                            <tr class="@(isSelected ? "selected" : "")" @onclick="() => SelectRecord(item)">
                                @foreach (var column in Columns)
                                {
                                    <td>@GetPropertyValue(item, column.PropertyName)</td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>

    <div class="record-inspector-panel">
        @if (SelectedItem == null)
        {
            <div class="no-selection">
                <p>Select a record to view details</p>
            </div>
        }
        else
        {
            @InspectorContent(SelectedItem)
        }
    </div>
</div>

@code {
    [Parameter] public IEnumerable<TItem>? Items { get; set; }
    [Parameter] public List<ColumnDef> Columns { get; set; } = new();
    [Parameter] public string Title { get; set; } = "Records";
    [Parameter] public bool ShowSearch { get; set; } = true;
    [Parameter] public RenderFragment<TItem> InspectorContent { get; set; } = null!;
    [Parameter] public EventCallback<TItem> OnRecordSelected { get; set; }
    [Parameter] public EventCallback<string> OnSearchChanged { get; set; }
    [Parameter] public EventCallback<(string column, bool ascending)> OnSortChanged { get; set; }
    [Parameter] public bool IsLoading { get; set; } = false;
    [Parameter] public int? TotalCount { get; set; }
    [Parameter] public int? FilteredCount { get; set; }

    private TItem? SelectedItem { get; set; }
    private string searchTerm = string.Empty;
    private string CurrentSortColumn = string.Empty;
    private bool CurrentSortAscending = true;
    private System.Timers.Timer? debounceTimer;

    protected override void OnInitialized()
    {
        // Initialize debounce timer for search
        debounceTimer = new System.Timers.Timer(500); // 500ms debounce
        debounceTimer.Elapsed += OnDebounceElapsed;
        debounceTimer.AutoReset = false;
    }

    private void HandleSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;

        // Reset and start debounce timer
        debounceTimer?.Stop();
        debounceTimer?.Start();
    }

    private async void OnDebounceElapsed(object? sender, ElapsedEventArgs e)
    {
        await InvokeAsync(async () =>
        {
            if (OnSearchChanged.HasDelegate)
            {
                await OnSearchChanged.InvokeAsync(searchTerm);
            }
        });
    }

    private async Task SelectRecord(TItem item)
    {
        SelectedItem = item;
        if (OnRecordSelected.HasDelegate)
        {
            await OnRecordSelected.InvokeAsync(item);
        }
    }

    private async Task HandleSortClick(string columnName)
    {
        if (CurrentSortColumn == columnName)
        {
            CurrentSortAscending = !CurrentSortAscending;
        }
        else
        {
            CurrentSortColumn = columnName;
            CurrentSortAscending = true;
        }

        if (OnSortChanged.HasDelegate)
        {
            await OnSortChanged.InvokeAsync((CurrentSortColumn, CurrentSortAscending));
        }
    }

    private object? GetPropertyValue(TItem item, string propertyName)
    {
        if (item == null) return null;
        var property = typeof(TItem).GetProperty(propertyName);
        return property?.GetValue(item);
    }

    public void Dispose()
    {
        debounceTimer?.Dispose();
    }
}